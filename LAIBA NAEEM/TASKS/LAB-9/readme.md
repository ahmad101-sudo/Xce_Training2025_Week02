# Lab 9: SPI Controller

**Lab 9A: SPI Master Controller**

**Module:** spi_master  

**Purpose:**  
The SPI Master provides serial communication with SPI slave devices. It generates the SPI clock (`spi_clk`), controls slave select signals (`spi_cs_n`), and manages full-duplex data transfer through `MOSI` and `MISO`.  

---

**Top Diagram**

![Top Diagram](top.png) 

---

**Module Diagram**

![Module Diagram](module.png)  

---

**Signals**

**Inputs**  
- `clk`: System clock input  
- `rst_n`: Active-low reset  
- `tx_data [DATA_WIDTH-1:0]`: Parallel data to transmit  
- `slave_sel [$clog2(NUM_SLAVES)-1:0]`: Selects which slave to communicate with  
- `start_transfer`: Starts SPI transfer when high  
- `cpol`: Clock polarity (0 = idle low, 1 = idle high)  
- `cpha`: Clock phase (0 = sample on leading edge, 1 = sample on trailing edge)  
- `clk_div [15:0]`: Clock divider for SPI clock generation  
- `spi_miso`: Serial input from slave  

**Outputs**  
- `rx_data [DATA_WIDTH-1:0]`: Received parallel data from slave  
- `transfer_done`: Indicates transfer completion  
- `busy`: SPI is currently transferring data  
- `spi_clk`: Generated SPI clock  
- `spi_mosi`: Serial output to slave  
- `spi_cs_n [NUM_SLAVES-1:0]`: Active-low chip select signals  


#
**SPI Clock Relationship**  
The SPI clock (`spi_clk`) is generated by dividing the system clock:  

\[
T_{SPI} = 2*(clk\_div + 1) *system_clk
\]  

Example: With `clk_div = 4`, one `spi_clk` cycle = 10 system clock cycles; half-cycle = 5 system clock cycles.  
![Module Diagram](timing_diagram.png)
#
**SPI Modes (CPOL/CPHA)**  

The SPI mode defines the **idle level of the clock** and the **edge on which data is sampled and launched**:  

| Mode | CPOL | CPHA | Clock Idle | Data Launch | Data Sample |
|------|------|------|------------|-------------|-------------|
| 0    | 0    | 0    | Low        | Falling     | Rising      |
| 1    | 0    | 1    | Low        | Rising      | Falling     |
| 2    | 1    | 0    | High       | Rising      | Falling     |
| 3    | 1    | 1    | High       | Falling     | Rising      |

- `spi_cs_n` must be asserted low before communication and de-asserted high after the final clock edge.  

**Mode 0 (CPOL = 0, CPHA = 0)**
Clock idles low. Data is launched on the falling edge and sampled on the rising edge.

![alt text](mode0(timing_diagram).png)

**Mode 1 (CPOL = 0, CPHA = 1)**  

Clock idles low. Data is launched on the rising edge and sampled on the falling edge. 

![alt text](mode1(timing_diagram).png)

**Mode 2 (CPOL = 1, CPHA = 0)** 

Clock idles high. Data is launched on the rising edge and sampled on the falling edge. 

![alt text](mode2(timing_diagram).png)

**Mode 3 (CPOL = 1, CPHA = 1)**

Clock idles high. Data is launched on the falling edge and sampled on the rising edge. 

![alt text](mode3(timing_diagram).png)
#
**Resources**

I mainly implemented the module myself. To understand and debug the SPI Master, I:  
- Read articles about SPI protocol, CPOL/CPHA, and data transfer  
- Watched examples and timing diagrams online to understand SPI modes  
- Faced difficulty while debugging clocking and data capture  
- Took help from AI to clarify control logic and transfer sequence  

#

**Code Quality Checklist**

- [x] Consistent naming conventions (`spi_mosi`, `spi_miso`, `spi_clk`, `spi_cs_n`)  
- [x] Proper module hierarchy (SPI Master, SPI Slave, Testbench separated)  
- [x] All outputs driven in all conditions (no floating outputs)  
- [x] Reset strategy consistent (active-low `rst_n`)  
- [x] Comments explain design intent (clock generation, data launch/sample edges, slave select control)  
